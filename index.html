<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Free IPTV Player</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    select, button { padding: 6px; margin: 5px 0; }
    video { width: 100%; max-width: 900px; height: 500px; background: black; }
    #status { margin-top: 10px; color: red; }
  </style>
</head>
<body>

<h1>Free IPTV Player</h1>

<select id="countrySelect"><option>Loading countries...</option></select><br>
<select id="categorySelect"><option>Select country first</option></select><br>
<select id="channelSelect"><option>Select category first</option></select><br>

<button id="playBtn">Play</button>

<div>
  <video id="player" controls></video>
  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>

<script>
const BASE_API = "https://iptv-org.github.io/api";
let channels = [];
let streams = [];
let blocked = new Set();
let hls = null;

const countrySelect = document.getElementById("countrySelect");
const categorySelect = document.getElementById("categorySelect");
const channelSelect = document.getElementById("channelSelect");
const statusDiv = document.getElementById("status");
const video = document.getElementById("player");

async function loadData() {
  try {
    const [chRes, stRes, blRes] = await Promise.all([
      fetch(`${BASE_API}/channels.json`),
      fetch(`${BASE_API}/streams.json`),
      fetch(`${BASE_API}/blocklist.json`)
    ]);

    channels = await chRes.json();
    streams = await stRes.json();
    const blocklist = await blRes.json();

    blocked = new Set(blocklist.map(b => b.channel));

    console.log("Channels:", channels.length);
    console.log("Streams:", streams.length);

    const countries = [...new Set(channels.map(c => c.country).filter(Boolean))].sort();
    countrySelect.innerHTML = "<option value=''>Select Country</option>";

    countries.forEach(c => {
      countrySelect.innerHTML += `<option value="${c}">${c}</option>`;
    });

  } catch (err) {
    statusDiv.textContent = "Failed to load IPTV data";
  }
}

countrySelect.addEventListener("change", () => {
  const country = countrySelect.value;
  categorySelect.innerHTML = "<option>Select Category</option>";
  channelSelect.innerHTML = "<option>Select Channel</option>";

  const cats = new Set();
  channels
    .filter(c => c.country === country)
    .forEach(c => c.categories?.forEach(cat => cats.add(cat)));

  [...cats].sort().forEach(cat => {
    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
});

categorySelect.addEventListener("change", () => {
  const country = countrySelect.value;
  const category = categorySelect.value;

  const filtered = channels.filter(c =>
    c.country === country &&
    c.categories?.includes(category) &&
    !blocked.has(c.id)
  );

  channelSelect.innerHTML = "<option value=''>Select Channel</option>";

  filtered.sort((a,b)=>a.name.localeCompare(b.name))
  .forEach(c => {
    channelSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
});

function getStreams(channelId) {
  return streams.filter(s =>
    s.channel === channelId &&
    s.url &&
    s.status !== "offline"
  );
}

document.getElementById("playBtn").addEventListener("click", () => {
  const channelId = channelSelect.value;

  if (!channelId) {
    statusDiv.textContent = "Select a channel";
    return;
  }

  const available = getStreams(channelId);

  if (!available.length) {
    statusDiv.textContent = "No streams available";
    return;
  }

  const streamURL = `/api/proxy?url=${encodeURIComponent(available[0].url)}`;

  if (hls) {
    hls.destroy();
  }

  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(streamURL);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
      statusDiv.textContent = "";
    });
    hls.on(Hls.Events.ERROR, () => {
      statusDiv.textContent = "Error playing stream";
    });
  } else {
    video.src = streamURL;
    video.play();
  }
});

loadData();
</script>

</body>
</html>
